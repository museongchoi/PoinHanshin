<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>상세페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" rel="stylesheet">
    <link href="/css/commonstyle.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
</head>
<style>

    button {
        float : right;
    }

  .commentbox {
        padding : 20px;
        border-top: 1px solid black;

    }
  .relpybox {
        padding : 20px;
         border-top: 1px solid black;
  }
   .commentbox2 {
        border-top: 1px solid black;
        padding : 30px;
  }
</style>
<body layout:fragment="content">
<div class="page">
<span class="fs-6">태그</span>
<!--    고양이=1(true), 강아지=0(false)-->

<span th:if="${boardDto.ani_category == 0}" class="badge rounded-pill text-bg-secondary">강아지</span>
<span th:if="${boardDto.ani_category == 1 }" class="badge text-bg-primary">고양이</span>


    <div class="row">
        <div class="form-floating">
            <input type="text" readonly class="form-control-plaintext"T
            id="floatingEmptyPlaintextInput"
            th:value="${boardDto.title}">
        <label for="floatingEmptyPlaintextInput">제목</label>
        </div>
    </div>

    <div class="row">
        <div class="col-mb-3">
<!--  이미지     -->
                  <div class="col-sm-6" th:each="image:${boardDto.board_imagepath}" th:if="${#strings.isEmpty(protectboard.protectboard_imagepath)}">
                    <img th:src="'data:image/jpeg;base64,'+${image}" class="img-fluid" alt="빈이미지">
                  </div>
            <textarea
                type="text"
                name="content"
                class="form-control"
                id="inputContent"
                th:value="${boardDto.content}"
                readonly="readonly"
                style="height: 300px;border:none"
            ></textarea>
        </div>
    </div>

    <div class="row">
        <span th:text="| 작성일 : ${boardDto.regDate}|">작성일:</span>
        <span th:text="| 조회수 : ${boardDto.viewcount}|">조회수:</span>
        <span th:text="| 작성자 : ${boardDto.board_users_id}|">작성자:</span>
    </div>

<!--댓글출력-->
<!--${commentList} 댓글리스트-->
    <div id="commentTable">
        <th:block th:each="commentDto:${commentList}">
        <div>
                <div class="commentbox" th:if="${#strings.isEmpty(commentDto.pcno)}">
                    <input type="hidden" id="commentno" name="cno" th:value="${commentDto.cno}">
                    <div>
                        <small th:text="${commentDto.boardcomment_userno}">유저id</small>
                        <small th:text="${#strings.substring(commentDto.reg_date,0,19)}"> 2010-11-11 10:51:03 (ex)</small>
                    </div>
                    <span th:text="${commentDto.comment}">내용</span>
                    <span>
                        <button type="button" data-bs-toggle="collapse"
                                       th:attr="data-bs-target=|#r${commentDto.cno}"
                                       th:if="${users.userno != null}"
                                       style="display:inline" class="btn btn-outline-primary btn-sm">답글달기
                        </button>
                    </span>
                    <span class="text-right" th:if="${commentDto.boardcomment_userno} == ${users.userno}">
                        <span><button type="button" data-bs-toggle="collapse" class="btn btn-outline-primary btn-sm"
                                      th:attr="data-bs-target=|#c${commentDto.cno}"style="display:inline" >수정</button>
                        </span>
                        <span><button type="submit" th:onclick="commentRemove([[${commentDto.cno}]]);" class="btn btn-outline-danger btn-sm"  name="submit" value="delete">삭제</button></span>
                    </span>
                </div>

<!--        댓글수정          -->
                <div class="collapse" th:id="c + ${commentDto.cno}">
                    <form  th:action="@{/comments/{cno}(cno=${commentDto.cno})}" th:object="${commentVO}" method="post">
                        <div class="input-group" style="width:auto">
                            <label for="content" class="form-label mt-4" hidden>댓글 작성</label>
                            <input type="text"  name="comment" class="form-control" th:text="${commentDto.comment}">
                            <input type="hidden" name="pcno" th:value="${commentDto.cno}"/>
                            <input type="hidden" name="boardcomment_userno" th:value="${users.userno}"/>
                            <button type="submit" class="btn btn-outline-dark">댓글작성</button>
                            <br>
                        </div>
                        <br>
                    </form>
                </div>


<!--        답글출력        -->
<!--parcommentno 답글을 구분-->
                    <div th:each="relpy:${commentList}" id="relybox">
                        <div class="relpybox" th:if="${#strings.equals(relpy.pcno, commentDto.cno)">
                            <i class="bi bi-arrow-90deg-up"></i>
                            <input type="hidden" id="replyno" name="relpyno" th:value="${relpy.cno}">
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="25" fill="currentColor" class="bi bi-arrow-90deg-up" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.854 1.146a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L4 2.707V12.5A2.5 2.5 0 0 0 6.5 15h8a.5.5 0 0 0 0-1h-8A1.5 1.5 0 0 1 5 12.5V2.707l3.146 3.147a.5.5 0 1 0 .708-.708l-4-4z"/>
                                </svg>
                                <small th:text="${relpy.boardcomment_userno}">유저id</small>
                                <small th:text="${#strings.substring(relpy.reg_date,0,19)}"> 2010-11-11 10:51:03 (ex)</small>
                            </div>
                            <span th:text="${relpy.comment}">답글내용</span>
                            <span class="text-right" th:if="${relpy.boardcomment_userno == users.userno}">
                                 <span><button type="button" data-bs-toggle="collapse" class="btn btn-outline-primary btn-sm"
                                              th:attr="data-bs-target=|#r${relpy.cno}"style="display:inline" >수정</button>
                                 </span>
                                <span><button type="button" th:onclick="commentRemove([[${relpy.cno}]]);" class="btn btn-outline-danger btn-sm">삭제</button></span>
                            </span>
                        </div>
                        <!--        답글수정          -->
                        <div class="collapse" th:id="r + ${relpy.cno}">
                            <form  th:action="@{/comments/{cno}(cno=${relpy.cno})}" method="post">
                                <div class="input-group" style="width:auto">
                                    <label for="content" class="form-label mt-4" hidden>댓글 작성</label>
                                    <input type="text"  name="comment" class="form-control">
                                    <input type="hidden" name="pcno" th:value="${relpy.cno}"/>
                                    <input type="hidden" name="boardcomment_userno" th:value="${users.userno}"/>
                                    <button type="submit" class="btn btn-outline-dark">댓글작성</button>
                                    <br>
                                </div>
                                <br>
                            </form>
                        </div>
                    </div>


                        <!--        답글 작성창      -->
                        <div class="collapse" th:id="r + ${commentDto.cno}">
                            <form  th:action="@{/comments(bno=${boardDto.bno})}" method="post">
                                <div class="input-group" style="width:auto">
                                    <label for="content" class="form-label mt-4" hidden>댓글 작성</label>
                                    <input type="text"  name="comment" class="form-control" th:text="${commentDto.comment}">
                                    <input type="hidden" name="pcno" th:value="${commentDto.cno}"/>
                                    <input type="hidden" name="boardcomment_userno" th:value="${users.userno}"/>
                                    <button type="submit" class="btn btn-outline-dark">답글작성</button>
                                    <br>pcno
                                </div>
                                <br>
                            </form>
                        </div>



        </div>
        </th:block>




    </div>



<!--댓글작성-->
    <div class="commentbox2">
        <div>
            <p class="comment2" th:if="${session.isEmpty()}">로그인 후 댓글을 작성할 수 있습니다.</p>
        </div>

        <div>
            <form th:unless="${session.isEmpty()}" th:action="@{/comments(bno=${boardDto.bno})}" th:object="${commentVO}" method="post">
                <div class="input-group" style="width:auto">
                    <input type="hidden" name="boardcomment_userno" th:value="${user.userno}">
                    <label for="content" class="form-label mt-4" hidden>댓글 작성</label>
                    <input type="text" th:field="*{comment}" class="form-control" id="content" name="content"
                                   placeholder="1자에서 100자 이내로 입력해주세요.">
                    <div class="field-error" th:errors="*{comment}">
                                오류2
                    </div>
                    <button type="submit" class="btn btn-outline-dark">작성</button>
                    <br>
                </div>
            </form>
        </div>
    </div>
        <form>
        <div class="col-7 p-3">
            <button type="button" th:onclick="|location.href='@{/board/modify}'|" class="btn btn-secondary">수정</button>
            <button type="button" onclick="removePost();" class="btn btn-danger">삭제</button>
        </div>
        </form>

<script th:inline="javascript">
/*<![CDATA[*/

//테스트용 콘솔창데이터확인용
const list = [[${boardDto}]];
console.log(list);

//댓글삭제
function commentRemove(commentno) {

                if ( !confirm('댓글을 삭제할까요?') ) {
                    return false;
                }

                const formHtml = `
                    <form id="deleteForm" action="/comments/remove/(cno=commentno)" method="post">
                        <input type="hidden" id="commentno" name="commentno" value="commentno" />
                    </form>
                `;
                const doc = new DOMParser().parseFromString(formHtml, 'text/html');
                const form = doc.body.firstChild;
                document.body.append(form);
                document.getElementById('deleteForm').submit();
            }

//게시글삭제
 function removePost() {
                const id = /*[[ ${boardDto.bno} ]]*/;

                if ( !confirm(id + '번 게시글을 삭제할까요?'); ) {
                    return false;
                }

                const formHtml = `
                    <form id="deleteForm" action="/board/remove" method="post">
                        <input type="hidden" id="bno" name="bno" value="${boardDto.bno}" />
                    </form>
                `;
                const doc = new DOMParser().parseFromString(formHtml, 'text/html');
                const form = doc.body.firstChild;
                document.body.append(form);
                document.getElementById('deleteForm').submit();
            }


/*]]>*/
</script>
</div>
</body>
</html>