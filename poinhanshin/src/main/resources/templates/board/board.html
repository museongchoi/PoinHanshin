<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>상세페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>


    button {
        float : right;
    }
    @media (min-width: 768px) {
      .page {
        width: 600px;
      }
    }

    @media (min-width: 992px) {
      .page {
        width: 940px;
      }
    }

    @media (min-width: 1200px) {
      .page {
        width: 940px;
      }
    }

  .page {
        margin: 0 auto;
        padding: 50px;
        border-left: 1px solid black;
        border-right: 1px solid black;
    }
  .commentbox {
        padding : 20px;
        border-top: 1px solid black;

    }
  .relpybox {
        padding : 20px;
         border-top: 1px solid black;
  }
   .commentbox2 {
        border-top: 1px solid black;
        padding : 30px;
  }
</style>
<body layout:fragment="content">
<div class="page">
<span class="fs-6">태그</span>
<!--    고양이=1(true), 강아지=0(false)-->
<span th:if="${boardDto.ani_category}" class="badge text-bg-primary">고양이</span>
<span th:unless="${boardDto.ani_category}" class="badge rounded-pill text-bg-secondary">강아지</span>


    <div class="row">
        <div class="form-floating">
            <input type="text" readonly class="form-control-plaintext"
            id="floatingEmptyPlaintextInput"
            th:value="${boardDto.title}">
        <label for="floatingEmptyPlaintextInput">제목</label>
        </div>
    </div>

    <div class="row">
        <div class="col-mb-3">
                  <div class="col-sm-6" th:each="imagePath:${boardDto.board_imagepath}" th:if="${boardDto.board_imagepath != null}">
                    <img th:src="${imagePath}" class="img-fluid" alt="빈이미지">
                  </div>
            <textarea
                type="text"
                name="content"
                class="form-control"
                id="inputContent"
                th:value="${boardDto.content}"
                readonly="readonly"
                style="height: 300px;border:none"
            ></textarea>
        </div>
    </div>

    <div class="row">
        <span th:text="| 작성일 : ${boardDto.reg_date}|">작성일:</span>
        <span th:text="| 조회수 : ${boardDto.viewcount}|">조회수:</span>
        <span th:text="| 작성자 : ${boardDto.board_users_id}|">작성자:</span>
    </div>

<!--댓글출력-->
<!--${commentList} 댓글리스트-->
    <div id="commentTable">
        <th:block th:each="commentDto:${commentList}">
        <div>
            <form th:action="@{/comments/{cno}(cno=${commentDto.commentno})}"   method="post" >
                <div class="commentbox" th:if="${#strings.isEmpty(commentDto.parcommentno)}">
                    <input type="hidden" id="commentno" name="commentno" th:value="${commentDto.commentno}">
                    <div>
                        <input type="button" class="btn p-0 btn-md" name="comment_userno" th:value="${commentDto.boardcomment_userno}" />유저id
                        <small th:text="${#strings.substring(commentDto.reg_date,0,19)}"> 2010-11-11 10:51:03 (ex)</small>
                    </div>
                    <span th:text="${commentDto.comment}">내용</span>
                    <span class="text-right" th:if="${commentDto.boardcomment_userno == users.userno}">
                        <span><button type="submit" class="btn btn-outline-primary btn-sm" name="submit" value="update">수정</button></span>
                        <span><button type="submit" class="btn btn-outline-danger btn-sm"  name="submit" value="delete">삭제</button></span>
                    </span>
                </div>

<!--대댓글-->
<!--이중반복문으로 commentList를 돌려서 '댓글번호==부모댓글번호'로 대댓글을 구분-->
                    <div th:each="commentDto:${commentList}" >
                        <div class="relpybox" th:if="${#strings.equals(commentDto.commentno, commentDto.parcommentno)">
                            <i class="bi bi-arrow-90deg-up"></i>
                            <input type="hidden" id="replyno" name="relpyno" th:value="${relpyDto.commentno}">
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="25" fill="currentColor" class="bi bi-arrow-90deg-up" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.854 1.146a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L4 2.707V12.5A2.5 2.5 0 0 0 6.5 15h8a.5.5 0 0 0 0-1h-8A1.5 1.5 0 0 1 5 12.5V2.707l3.146 3.147a.5.5 0 1 0 .708-.708l-4-4z"/>
                                </svg>
                                <input type="button" class="btn p-0 btn-md" name="comment_userno" th:value="${relpyDto.boardcomment_userno}"/>유저id
                                <small th:text="${#strings.substring(commentDto.reg_date,0,19)}"> 2010-11-11 10:51:03 (ex)</small>
                            </div>
                            <span th:text="${relpyDto.comment}">대댓글내용</span>
                            <span class="text-right" th:if="${relpyDto.boardcomment_userno == users.userno}">
                                <span><button type="submit" class="btn btn-outline-primary btn-sm" name="submit" value="update">수정</button></span>
                                <span><button type="submit" class="btn btn-outline-danger btn-sm"  name="submit" value="delete">삭제</button></span>
                            </span>
                        </div>
                    </div>
            </form>
        </div>
        </th:block>
    </div>

<!--댓글작성-->
    <div class="commentbox2">
        <div>
            <p class="comment2" th:if="${session.isEmpty()}">로그인 후 댓글을 작성할 수 있습니다.</p>
        </div>

        <div>
            <form th:unless="${session.isEmpty()}" th:action="@{/comments(bno=${boardDto.boardno})}" th:object="${commentVO}" method="post">
                <div class="input-group" style="width:auto">

                    <label for="content" class="form-label mt-4" hidden>댓글 작성</label>
                    <input type="text" th:field="*{comment}" class="form-control" id="content" name="content"
                                   placeholder="1자에서 100자 이내로 입력해주세요.">
                    <div class="field-error" th:errors="*{comment}">
                                오류2
                    </div>
                    <button type="submit" class="btn btn-outline-dark">작성</button>
                    <br>
                </div>
            </form>
        </div>
    </div>
        <form>
        <div class="col-7 p-3">
            <button type="button" th:onclick="|location.href='@{/board/modify}'|" class="btn btn-secondary">수정</button>
            <button type="button" onclick="removePost();" class="btn btn-danger">삭제</button>
        </div>
        </form>

<script th:inline="javascript">
/*<![CDATA[*/

        window.onload = () => {
        findAllComment();
    }

//게시글삭제
 function removePost() {
                const id = /*[[ ${boardDto.boardno} ]]*/;

                if ( !confirm(id + '번 게시글을 삭제할까요?') ) {
                    return false;
                }

                const formHtml = `
                    <form id="deleteForm" action="/board/remove" method="post">
                        <input type="hidden" id="id" name="id" value="${id}" />
                    </form>
                `;
                const doc = new DOMParser().parseFromString(formHtml, 'text/html');
                const form = doc.body.firstChild;
                document.body.append(form);
                document.getElementById('deleteForm').submit();
            }



       // 댓글 조회 ajax 임시
       
//function findAllComment() {

    const postId = /*[[ ${boardDto.boardno} ]]*/

    $.ajax({
        url : `/comments`,
        type : 'get',
        dataType : 'json',
        async : false,
        success : function (response) {

            // 1. 조회된 데이터가 없는 경우
            if ( !response.length ) {
                document.querySelector('.cm_list').innerHTML = '<div class="cm_none"><p>등록된 댓글이 없습니다.</p></div>';
                return false;
            }

            // 2. 렌더링 할 HTML을 저장할 변수
            let commentHtml = '';

            // 3. 댓글 HTML 추가
            response.forEach(row => {
                commentHtml += `
                    <div>
                       <p class="writer">
                            <em>${row.writer}</em>
                            <span class="date">${dayjs(row.createdDate).format('YYYY-MM-DD HH:mm')}</span>
                        </p>
                        <div class="cont"><div class="txt_con">${row.content}</div></div>
                        <p class="func_btns">
                            <button type="button" class="btns"><span class="icons icon_modify">수정</span></button>
                            <button type="button" class="btns"><span class="icons icon_del">삭제</span></button>
                        </p>
                    </div>
                `;
            })

            // 4. class가 "cm_list"인 요소를 찾아 HTML을 렌더링
            document.querySelector('.cm_list').innerHTML = commentHtml;
        },
        error : function (request, status, error) {
            console.log(error)
        }
    })
}
/*]]>*/
</script>
</div>
</body>
</html>